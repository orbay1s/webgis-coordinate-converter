<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenGIS-TR | Koordinat Dönüştürücü</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent full page scroll */
            background-color: #f8f9fa;
        }
        
        /* Navbar height fixed */
        .navbar {
            height: 56px;
            z-index: 1050;
        }

        /* Main Layout */
        .main-container {
            height: calc(100vh - 56px); /* Full height minus navbar */
            display: flex;
            flex-direction: row;
        }

        /* Sidebar Styling */
        #sidebar {
            width: 350px;
            background-color: white;
            overflow-y: auto;
            border-right: 1px solid #dee2e6;
            z-index: 1020;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Map Container Styling - CRITICAL FIX FOR GRAY MAP */
        #map-wrapper {
            flex-grow: 1;
            position: relative;
            background-color: #e9ecef;
            height: 100%;
            width: 100%;
        }
        
        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Custom Search Bar Overlay */
        #search-overlay {
            position: absolute;
            top: 10px;
            left: 50px; /* Right of Zoom controls */
            z-index: 1000;
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* Input Styling */
        .border-source { border-color: #0d6efd !important; }
        .bg-source { background-color: #0d6efd !important; color: white; }
        .text-source { color: #0d6efd !important; }

        .border-target { border-color: #fd7e14 !important; }
        .bg-target { background-color: #fd7e14 !important; color: white; }
        .text-target { color: #fd7e14 !important; }

        .result-box {
            background-color: #f8f9fa;
            font-weight: bold;
            font-family: monospace;
            font-size: 1rem;
        }
        
        /* Custom Scrollbar */
        #sidebar::-webkit-scrollbar { width: 6px; }
        #sidebar::-webkit-scrollbar-track { background: #f1f1f1; }
        #sidebar::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }

        /* SVG Icon Classes */
        .custom-div-icon {
            background: transparent;
            border: none;
        }
        .drop-shadow {
            filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.4));
        }

        /* Utilities */
        .text-xs { font-size: 0.75rem; }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            #sidebar { width: 100%; height: 50%; border-right: none; border-bottom: 1px solid #dee2e6; }
            #map-wrapper { height: 50%; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <nav class="navbar navbar-dark bg-dark px-3 shadow-sm">
        <span class="navbar-brand mb-0 h1 d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0d6efd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"></polygon><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="6" x2="15" y2="21"></line></svg>
            ProGIS <span class="badge bg-light text-dark ms-2 fw-normal" style="font-size: 0.75rem;">V9.0 VANILLA</span>
        </span>
    </nav>

    <!-- Main Layout -->
    <div class="main-container">
        
        <!-- Sidebar -->
        <div id="sidebar" class="p-3 shadow">
            
            <!-- Alert Box -->
            <div id="alert-box" style="min-height: 40px;">
                <!-- Alerts injected via JS -->
            </div>

            <!-- Source Input Card -->
            <div class="card shadow-sm border-source">
                <div class="card-header bg-source fw-bold d-flex justify-content-between align-items-center">
                    <span class="small">INPUT (SOURCE)</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6"/></svg>
                </div>
                <div class="card-body p-2">
                    <div class="mb-2">
                        <select id="src-crs" class="form-select form-select-sm border-source fw-bold"></select>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label text-muted text-xs mb-0">X / Easting / Lon</label>
                            <input type="number" id="src-x" class="form-control form-control-sm" placeholder="0.00">
                        </div>
                        <div class="col-6">
                            <label class="form-label text-muted text-xs mb-0">Y / Northing / Lat</label>
                            <input type="number" id="src-y" class="form-control form-control-sm" placeholder="0.00">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex justify-content-between gap-2">
                <button id="btn-zoom" class="btn btn-primary btn-sm flex-grow-1 fw-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    ZOOM TO RESULT
                </button>
                <button id="btn-clear" class="btn btn-outline-danger btn-sm" title="Clear All">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>
                </button>
            </div>

            <!-- Target Output Card -->
            <div class="card shadow-sm border-target">
                <div class="card-header bg-target fw-bold d-flex justify-content-between align-items-center">
                    <span class="small">OUTPUT (TARGET)</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6"/></svg>
                </div>
                <div class="card-body p-2">
                    <div class="mb-2">
                        <select id="tgt-crs" class="form-select form-select-sm border-target fw-bold"></select>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label text-muted text-xs mb-0">Result X</label>
                            <input type="text" id="res-x" class="form-control form-control-sm result-box" readonly placeholder="---">
                        </div>
                        <div class="col-6">
                            <label class="form-label text-muted text-xs mb-0">Result Y</label>
                            <input type="text" id="res-y" class="form-control form-control-sm result-box" readonly placeholder="---">
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-auto text-center text-muted small text-xs border-top pt-2">
                Single File WebGIS &bull; No Build &bull; V9.0
            </div>
        </div>

        <!-- Map Area -->
        <div id="map-wrapper">
            
            <!-- Custom Search Overlay -->
            <div id="search-overlay">
                <form id="search-form" class="input-group input-group-sm">
                    <input type="text" id="search-input" class="form-control border-primary" placeholder="Search address (Nominatim)...">
                    <button type="submit" class="btn btn-primary" id="search-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                </form>
                <div id="search-error" class="text-danger small mt-1 fw-bold" style="display:none;">Location not found</div>
            </div>

            <!-- The Map -->
            <div id="map"></div>

            <!-- Legend -->
            <div class="position-absolute bottom-0 end-0 m-3 p-2 bg-white rounded shadow border d-flex flex-column gap-1" style="z-index: 1000; font-size: 0.75rem;">
                <div class="d-flex align-items-center gap-2">
                  <span class="d-inline-block border border-primary bg-primary bg-opacity-25 rounded-circle" style="width: 14px; height: 14px;"></span>
                  <strong>Input (Source)</strong>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="d-inline-block border border-danger bg-danger bg-opacity-25 rounded-circle" style="width: 14px; height: 14px;"></span>
                  <strong>Output (Target)</strong>
                </div>
             </div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.10.0/proj4.js"></script>

    <!-- Application Logic -->
    <script>
        // --- 1. DATA & CONSTANTS ---
        const TR_LAT_MIN = 35.0;
        const TR_LAT_MAX = 43.0;

        const CRS_DEFINITIONS = [
            // Global
            { code: 'EPSG:4326', name: 'WGS 84 (Lat/Lon)', proj4: '+proj=longlat +datum=WGS84 +no_defs', bounds: [-180, -90, 180, 90] },
            { code: 'EPSG:3857', name: 'Web Mercator', proj4: '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs', bounds: [-180, -85, 180, 85] },
            // UTM 6 Degree
            { code: 'EPSG:32635', name: 'UTM Zone 35N (WGS84)', proj4: '+proj=utm +zone=35 +datum=WGS84 +units=m +no_defs', bounds: [24, TR_LAT_MIN, 30, TR_LAT_MAX] },
            { code: 'EPSG:32636', name: 'UTM Zone 36N (WGS84)', proj4: '+proj=utm +zone=36 +datum=WGS84 +units=m +no_defs', bounds: [30, TR_LAT_MIN, 36, TR_LAT_MAX] },
            { code: 'EPSG:32637', name: 'UTM Zone 37N (WGS84)', proj4: '+proj=utm +zone=37 +datum=WGS84 +units=m +no_defs', bounds: [36, TR_LAT_MIN, 42, TR_LAT_MAX] },
            { code: 'EPSG:32638', name: 'UTM Zone 38N (WGS84)', proj4: '+proj=utm +zone=38 +datum=WGS84 +units=m +no_defs', bounds: [42, TR_LAT_MIN, 48, TR_LAT_MAX] },
            // ITRF96 3 Degree
            { code: 'ITRF96:TM27', name: 'ITRF96 / TM27', proj4: '+proj=tmerc +lat_0=0 +lon_0=27 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs', bounds: [25.5, TR_LAT_MIN, 28.5, TR_LAT_MAX] },
            { code: 'ITRF96:TM30', name: 'ITRF96 / TM30', proj4: '+proj=tmerc +lat_0=0 +lon_0=30 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs', bounds: [28.5, TR_LAT_MIN, 31.5, TR_LAT_MAX] },
            { code: 'ITRF96:TM33', name: 'ITRF96 / TM33', proj4: '+proj=tmerc +lat_0=0 +lon_0=33 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs', bounds: [31.5, TR_LAT_MIN, 34.5, TR_LAT_MAX] },
            { code: 'ITRF96:TM36', name: 'ITRF96 / TM36', proj4: '+proj=tmerc +lat_0=0 +lon_0=36 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs', bounds: [34.5, TR_LAT_MIN, 37.5, TR_LAT_MAX] },
            { code: 'ITRF96:TM39', name: 'ITRF96 / TM39', proj4: '+proj=tmerc +lat_0=0 +lon_0=39 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs', bounds: [37.5, TR_LAT_MIN, 40.5, TR_LAT_MAX] },
            { code: 'ITRF96:TM42', name: 'ITRF96 / TM42', proj4: '+proj=tmerc +lat_0=0 +lon_0=42 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs', bounds: [40.5, TR_LAT_MIN, 43.5, TR_LAT_MAX] },
            { code: 'ITRF96:TM45', name: 'ITRF96 / TM45', proj4: '+proj=tmerc +lat_0=0 +lon_0=45 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs', bounds: [43.5, TR_LAT_MIN, 46.5, TR_LAT_MAX] },
            // ED50 3 Degree
            { code: 'ED50:TM27', name: 'ED50 / TM27', proj4: '+proj=tmerc +lat_0=0 +lon_0=27 +k=1 +x_0=500000 +y_0=0 +ellps=intl +towgs84=-87,-98,-121,0,0,0,0 +units=m +no_defs', bounds: [25.5, TR_LAT_MIN, 28.5, TR_LAT_MAX] },
            { code: 'ED50:TM30', name: 'ED50 / TM30', proj4: '+proj=tmerc +lat_0=0 +lon_0=30 +k=1 +x_0=500000 +y_0=0 +ellps=intl +towgs84=-87,-98,-121,0,0,0,0 +units=m +no_defs', bounds: [28.5, TR_LAT_MIN, 31.5, TR_LAT_MAX] },
            { code: 'ED50:TM33', name: 'ED50 / TM33', proj4: '+proj=tmerc +lat_0=0 +lon_0=33 +k=1 +x_0=500000 +y_0=0 +ellps=intl +towgs84=-87,-98,-121,0,0,0,0 +units=m +no_defs', bounds: [31.5, TR_LAT_MIN, 34.5, TR_LAT_MAX] },
            { code: 'ED50:TM36', name: 'ED50 / TM36', proj4: '+proj=tmerc +lat_0=0 +lon_0=36 +k=1 +x_0=500000 +y_0=0 +ellps=intl +towgs84=-87,-98,-121,0,0,0,0 +units=m +no_defs', bounds: [34.5, TR_LAT_MIN, 37.5, TR_LAT_MAX] },
            { code: 'ED50:TM39', name: 'ED50 / TM39', proj4: '+proj=tmerc +lat_0=0 +lon_0=39 +k=1 +x_0=500000 +y_0=0 +ellps=intl +towgs84=-87,-98,-121,0,0,0,0 +units=m +no_defs', bounds: [37.5, TR_LAT_MIN, 40.5, TR_LAT_MAX] },
            { code: 'ED50:TM42', name: 'ED50 / TM42', proj4: '+proj=tmerc +lat_0=0 +lon_0=42 +k=1 +x_0=500000 +y_0=0 +ellps=intl +towgs84=-87,-98,-121,0,0,0,0 +units=m +no_defs', bounds: [40.5, TR_LAT_MIN, 43.5, TR_LAT_MAX] },
            { code: 'ED50:TM45', name: 'ED50 / TM45', proj4: '+proj=tmerc +lat_0=0 +lon_0=45 +k=1 +x_0=500000 +y_0=0 +ellps=intl +towgs84=-87,-98,-121,0,0,0,0 +units=m +no_defs', bounds: [43.5, TR_LAT_MIN, 46.5, TR_LAT_MAX] },
        ];

        // Register Proj4 Definitions
        CRS_DEFINITIONS.forEach(def => {
            proj4.defs(def.code, def.proj4);
        });

        // --- 2. GLOBAL STATE ---
        let map;
        let sourceRect = null, targetRect = null;
        let sourceMarker, targetMarker;
        let srcCode = 'ITRF96:TM30';
        let tgtCode = 'ITRF96:TM33';
        
        // --- 3. UI INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Populate Selects
            const srcSelect = document.getElementById('src-crs');
            const tgtSelect = document.getElementById('tgt-crs');

            CRS_DEFINITIONS.forEach(crs => {
                const optSrc = new Option(crs.name, crs.code);
                const optTgt = new Option(crs.name, crs.code);
                srcSelect.add(optSrc);
                tgtSelect.add(optTgt);
            });

            // Set Defaults
            srcSelect.value = srcCode;
            tgtSelect.value = tgtCode;

            // Init Map
            initMap();
            updateMapZones();

            // Event Listeners
            srcSelect.addEventListener('change', (e) => { srcCode = e.target.value; updateMapZones(); calculate(); });
            tgtSelect.addEventListener('change', (e) => { tgtCode = e.target.value; updateMapZones(); calculate(); });
            document.getElementById('src-x').addEventListener('input', calculate);
            document.getElementById('src-y').addEventListener('input', calculate);
            
            document.getElementById('btn-clear').addEventListener('click', clearAll);
            document.getElementById('btn-zoom').addEventListener('click', zoomToResult);

            // Search Form
            document.getElementById('search-form').addEventListener('submit', handleSearch);
        });

        // --- 4. MAP LOGIC ---
        function initMap() {
            // Initialize Leaflet Map
            map = L.map('map', { zoomControl: false }).setView([39.0, 35.0], 6);
            L.control.zoom({ position: 'topleft' }).addTo(map);

            // Base Layers
            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19, attribution: '© OpenStreetMap'
            }).addTo(map);
            
            const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19, attribution: '© Esri'
            });

            L.control.layers({ "Street": osm, "Satellite": sat }, null, { position: 'topright' }).addTo(map);

            // SVG Icons for Markers
            const blueIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#0d6efd" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-100 h-100 drop-shadow"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>`,
                iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
            });

            const redIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#dc3545" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-100 h-100 drop-shadow"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>`,
                iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
            });

            // Markers
            sourceMarker = L.marker([0,0], { icon: blueIcon, opacity: 0 }).addTo(map).bindPopup("Source (Input)");
            targetMarker = L.marker([0,0], { icon: redIcon, opacity: 0 }).addTo(map).bindPopup("Target (Result)");

            // Map Click -> Inverse Calculation
            map.on('click', (e) => {
                const wgsLat = e.latlng.lat;
                const wgsLon = e.latlng.lng;
                
                // WGS84 -> Source CRS
                let sourcePt;
                try {
                   sourcePt = proj4('EPSG:4326', srcCode, [wgsLon, wgsLat]);
                } catch(err) {
                   console.error("Proj4 Error:", err);
                   return;
                }
                
                // Update Inputs
                const decimals = srcCode === 'EPSG:4326' ? 7 : 3;
                document.getElementById('src-x').value = sourcePt[0].toFixed(decimals);
                document.getElementById('src-y').value = sourcePt[1].toFixed(decimals);
                
                calculate();
            });
        }

        function updateMapZones() {
            // Remove old rects
            if (sourceRect) map.removeLayer(sourceRect);
            if (targetRect) map.removeLayer(targetRect);

            // Draw Source Zone (Blue)
            const srcDef = CRS_DEFINITIONS.find(c => c.code === srcCode);
            if (srcDef && srcDef.bounds) {
                const [minLon, minLat, maxLon, maxLat] = srcDef.bounds;
                sourceRect = L.rectangle([[minLat, minLon], [maxLat, maxLon]], {
                    color: '#0d6efd', weight: 1, fillColor: '#0d6efd', fillOpacity: 0.1, dashArray: '5,5', interactive: false
                }).addTo(map);
            }

            // Draw Target Zone (Orange)
            const tgtDef = CRS_DEFINITIONS.find(c => c.code === tgtCode);
            if (tgtDef && tgtDef.bounds) {
                const [minLon, minLat, maxLon, maxLat] = tgtDef.bounds;
                targetRect = L.rectangle([[minLat, minLon], [maxLat, maxLon]], {
                    color: '#fd7e14', weight: 1, fillColor: '#fd7e14', fillOpacity: 0.15, interactive: false
                }).addTo(map);
            }
        }

        // --- 5. CALCULATION & VALIDATION ---
        function calculate() {
            const xStr = document.getElementById('src-x').value;
            const yStr = document.getElementById('src-y').value;
            const alertBox = document.getElementById('alert-box');
            const resX = document.getElementById('res-x');
            const resY = document.getElementById('res-y');

            alertBox.innerHTML = ''; // Reset alerts

            if (xStr === '' || yStr === '') {
                sourceMarker.setOpacity(0);
                targetMarker.setOpacity(0);
                resX.value = '';
                resY.value = '';
                return;
            }

            const x = parseFloat(xStr);
            const y = parseFloat(yStr);

            if (isNaN(x) || isNaN(y)) return;

            // 1. Project Source -> WGS84 (for Marker and Validation)
            let wgsInput;
            try {
                wgsInput = proj4(srcCode, 'EPSG:4326', [x, y]);
            } catch (e) { console.error(e); return; }

            // Update Blue Marker
            sourceMarker.setLatLng([wgsInput[1], wgsInput[0]]).setOpacity(1);

            // 2. Project Source -> Target (Calculation)
            let targetResult;
            try {
                targetResult = proj4(srcCode, tgtCode, [x, y]);
            } catch (e) { 
                resX.value = "Error"; resY.value = "Error"; return; 
            }

            // Update Result Inputs
            const decimals = tgtCode === 'EPSG:4326' ? 7 : 3;
            resX.value = targetResult[0].toFixed(decimals);
            resY.value = targetResult[1].toFixed(decimals);

            // 3. Project Target -> WGS84 (for Red Marker and Cross-Zone check)
            let wgsOutput;
            try {
                wgsOutput = proj4(tgtCode, 'EPSG:4326', targetResult);
            } catch (e) { return; }

            // Update Red Marker
            targetMarker.setLatLng([wgsOutput[1], wgsOutput[0]]).setOpacity(1);

            // --- VALIDATION HIERARCHY ---
            const srcDef = CRS_DEFINITIONS.find(c => c.code === srcCode);
            const tgtDef = CRS_DEFINITIONS.find(c => c.code === tgtCode);

            const isSourceValid = checkBounds(wgsInput, srcDef.bounds);
            const isTargetValid = checkBounds(wgsOutput, tgtDef.bounds);

            if (!isSourceValid) {
                alertBox.innerHTML = `<div class="alert alert-danger p-2 small fw-bold d-flex align-items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg> Source Coordinates Outside Zone</div>`;
            } else if (!isTargetValid) {
                alertBox.innerHTML = `<div class="alert alert-warning p-2 small fw-bold text-dark d-flex align-items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-circle-fill me-2" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/></svg> Result Outside Target Zone</div>`;
            } else {
                alertBox.innerHTML = `<div class="alert alert-success p-2 small fw-bold d-flex align-items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill me-2" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg> Valid Transformation</div>`;
            }
        }

        function checkBounds(pt, bounds) {
            if (!bounds) return true;
            const [lon, lat] = pt; // Proj4 returns [x, y] -> [lon, lat]
            const [minLon, minLat, maxLon, maxLat] = bounds;
            // Strict check
            return (lon >= minLon && lon <= maxLon && lat >= minLat && lat <= maxLat);
        }

        // --- 6. UTILITIES ---
        function clearAll() {
            document.getElementById('src-x').value = '';
            document.getElementById('src-y').value = '';
            document.getElementById('res-x').value = '';
            document.getElementById('res-y').value = '';
            document.getElementById('alert-box').innerHTML = '';
            document.getElementById('search-input').value = '';
            document.getElementById('search-error').style.display = 'none';
            sourceMarker.setOpacity(0);
            targetMarker.setOpacity(0);
        }

        function zoomToResult() {
            const group = L.featureGroup();
            if (sourceMarker.options.opacity > 0) group.addLayer(sourceMarker);
            if (targetMarker.options.opacity > 0) group.addLayer(targetMarker);
            
            if (group.getLayers().length > 0) {
                map.flyToBounds(group.getBounds(), { padding: [50, 50], maxZoom: 15, duration: 1 });
            }
        }

        // --- 7. CUSTOM SEARCH (Nominatim) ---
        async function handleSearch(e) {
            e.preventDefault();
            const query = document.getElementById('search-input').value;
            const errorDiv = document.getElementById('search-error');
            const btn = document.getElementById('search-btn');

            if (!query) return;

            // Loading state
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    const name = data[0].display_name;

                    // 1. Move Map
                    map.flyTo([lat, lon], 14);
                    
                    // 2. Show Popup
                    L.popup()
                        .setLatLng([lat, lon])
                        .setContent(`<div style="text-align:center; font-size: 0.8rem;"><b>Found Location</b><br>${name}</div>`)
                        .openOn(map);

                    // 3. Convert WGS84 -> Source CRS and Fill Inputs
                    let sourcePt;
                    try {
                        sourcePt = proj4('EPSG:4326', srcCode, [lon, lat]);
                    } catch(err) { console.error(err); return; }

                    const decimals = srcCode === 'EPSG:4326' ? 7 : 3;
                    
                    document.getElementById('src-x').value = sourcePt[0].toFixed(decimals);
                    document.getElementById('src-y').value = sourcePt[1].toFixed(decimals);
                    
                    calculate(); // Trigger engine
                } else {
                    errorDiv.style.display = 'block';
                }
            } catch (err) {
                console.error(err);
                errorDiv.innerText = "Network Error";
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`;
            }
        }
    </script>
</body>

</html>
